<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Movies</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #111;
  color: #fff;
  min-height: 100vh;
  overflow-x: hidden;
}

header {
  padding: 14px;
  text-align: center;
  font-size: 50px;
  font-weight: 600;
  background-color: #0d0d0d;
  color: #b8b4b4;
  letter-spacing: 0.5px;
}

#searchInput {
  width: 80%;
  max-width: 500px;
  padding: 10px 14px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  margin: 20px auto;
  display: block;
  background-color: #222;
  color: #fff;
}

#main {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
  padding: 20px;
}

.card {
  background-color: #1a1a1a;
  border-radius: 8px;
  overflow: hidden;
  transition: transform 0.2s;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.card:hover { transform: scale(1.05); }

.card img { width: 100%; height: 240px; object-fit: cover; display: block; }

.card h4 { padding: 10px; font-size: 16px; text-align: center; }

#modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.95);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  padding: 20px;
}

#modalContent {
  max-width: 90%;
  width: 900px;
  background-color: #222;
  border-radius: 10px;
  overflow: hidden;
  padding: 20px;
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#modalTitle {
  font-size: 22px;
  text-align: center;
  margin-bottom: 10px;
}

.modal-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.modal-controls select,
.control-btn {
  background-color: #2a2a2a;
  color: white;
  border: 1px solid #555;
  padding: 8px 10px;
  border-radius: 6px;
  font-size: 14px;
  margin: 4px;
  appearance: none;
  height: 40px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.modal-controls select:focus,
.control-btn:focus { outline: none; box-shadow: 0 0 4px #b8b4b4; }

#fullscreenBtn {
  background-color: #2a2a2a;
  color: #fff;
  border: 1px solid #555;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin: 4px;
}
#fullscreenBtn:hover { background-color: #333; }

#fullscreenBtn img {
  width: 20px;
  height: 20px;
  object-fit: contain;
  pointer-events: none;
}

#closeModal {
  position: absolute;
  top: 10px;
  right: 14px;
  background: #ff3b3b;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

#closeModal:hover { background: #ff1f1f; }

#iframeWrap {
  width: 100%;
  height: 500px;
  background: #000;
  border-radius: 6px;
  overflow: hidden;
  display: none; /* hide initially */
}

#modalIframe {
  width: 100%;
  height: 100%;
  border: none;
  background: #000;
  display: block;
}

#iframeWrap:fullscreen,
#iframeWrap:-webkit-full-screen,
#iframeWrap:-moz-full-screen,
#iframeWrap:-ms-fullscreen {
  width: 100vw !important;
  height: 100vh !important;
  max-width: none !important;
  border-radius: 0 !important;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
}

#iframeWrap:fullscreen #modalIframe,
#iframeWrap:-webkit-full-screen #modalIframe,
#iframeWrap:-moz-full-screen #modalIframe,
#iframeWrap:-ms-fullscreen #modalIframe {
  width: 100vw !important;
  height: 100vh !important;
  border-radius: 0 !important;
}

@media screen and (max-width: 768px) {
  #modalIframe { height: 300px; }
  #searchInput { width: 90%; }
  #iframeWrap { height: 300px; }
}
</style>
</head>
<body>
<header>Rat Games Movies</header>
<input id="searchInput" placeholder="Search Movies or TV Shows" />
<div id="main"></div>

<div id="modal">
  <div id="modalContent">
    <button id="closeModal">Close</button>
    <div id="modalTitle"></div>

    <div class="modal-controls">
      <select id="seasonSelect" style="display: none;"></select>
      <select id="episodeSelect" style="display: none;"></select>
      <select id="sourceSelect"></select>

      <button id="fullscreenBtn" type="button" aria-label="Toggle fullscreen">
        <img src="https://cty3ctyc42yjmxt3499ctn924u9xaje5y.vercel.app/media/fullscreen.png" alt="fullscreen icon">
        <span>Fullscreen</span>
      </button>
    </div>

    <div id="iframeWrap">
      <iframe id="modalIframe" allowfullscreen></iframe>
    </div>
  </div>
</div>

<script>
const API_KEY = '3a73619bbb8fc6d47742d1b5b2b707b5';
const baseURL = 'https://api.themoviedb.org/3';
const main = document.getElementById('main');
const searchInput = document.getElementById('searchInput');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalIframe = document.getElementById('modalIframe');
const sourceSelect = document.getElementById('sourceSelect');
const seasonSelect = document.getElementById('seasonSelect');
const episodeSelect = document.getElementById('episodeSelect');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const iframeWrap = document.getElementById('iframeWrap');

let currentItem = null;
let currentPage = 1;
let loading = false;
let inSearch = false;

const tvSources = [
  'https://vidsrc.xyz/embed/tv?tmdb=${id}&season=${season}&episode=${episode}',
  'https://player.vidsrc.co/embed/tv/${id}/${season}/${episode}?server=2'
];

const movieSources = [
  'https://vidsrc.xyz/embed/movie?tmdb=${id}',
  'https://player.vidsrc.co/embed/movie/${id}?server=2'
];

async function fetchItems(type='movie', page=1){
  const res = await fetch(`${baseURL}/${type}/popular?api_key=${API_KEY}&language=en-US&page=${page}`);
  const data = await res.json();
  return data.results;
}

async function searchItems(query){
  const res = await fetch(`${baseURL}/search/multi?api_key=${API_KEY}&language=en-US&query=${query}`);
  const data = await res.json();
  return data.results;
}

async function loadItems(){
  if(loading || inSearch) return;
  loading = true;
  const movies = await fetchItems('movie', currentPage);
  const shows = await fetchItems('tv', currentPage);
  [...movies,...shows].forEach(createCard);
  currentPage++;
  loading = false;
}

function createCard(item){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <img src="https://image.tmdb.org/t/p/w500${item.poster_path}" alt="">
    <h4>${item.title || item.name}</h4>
  `;
  card.onclick = () => openModal(item);
  main.appendChild(card);
}

function openModal(item){
  currentItem = item;
  modal.style.display = 'flex';
  modalTitle.textContent = item.title || item.name;

  seasonSelect.style.display = 'none';
  episodeSelect.style.display = 'none';
  sourceSelect.innerHTML = '';
  iframeWrap.style.display = 'none';
  modalIframe.src = ''; // do NOT load iframe yet

  if(item.media_type === 'tv' || item.first_air_date){
    fetch(`${baseURL}/tv/${item.id}?api_key=${API_KEY}`)
      .then(res=>res.json())
      .then(data=>{
        const seasons = data.seasons || [];
        seasonSelect.innerHTML='';
        seasons.forEach(s=>{
          if(s.season_number===0) return;
          const opt = document.createElement('option');
          opt.value=s.season_number;
          opt.text=s.name;
          seasonSelect.appendChild(opt);
        });
        if(seasonSelect.options.length){
          seasonSelect.style.display='inline-block';
          seasonSelect.onchange = ()=> loadEpisodes(item.id, seasonSelect.value);
          seasonSelect.selectedIndex = 0;
          seasonSelect.dispatchEvent(new Event('change'));
        }
      });
  } else {
    movieSources.forEach(link=>{
      const opt = document.createElement('option');
      opt.value = link.replace('${id}', item.id);
      opt.textContent = new URL(opt.value).hostname;
      sourceSelect.appendChild(opt);
    });
    sourceSelect.selectedIndex = 0;
  }

  sourceSelect.onchange = () => {}; // no auto-load
}

function loadEpisodes(tvId, seasonNum){
  fetch(`${baseURL}/tv/${tvId}/season/${seasonNum}?api_key=${API_KEY}`)
    .then(res=>res.json())
    .then(data=>{
      episodeSelect.innerHTML='';
      (data.episodes || []).forEach(ep=>{
        const opt = document.createElement('option');
        opt.value = ep.episode_number;
        opt.text = ep.name || `Episode ${ep.episode_number}`;
        episodeSelect.appendChild(opt);
      });
      if(episodeSelect.options.length){
        episodeSelect.style.display='inline-block';
        episodeSelect.selectedIndex=0;
      }
    });
}

document.getElementById('closeModal').onclick = ()=>{
  modal.style.display='none';
  modalIframe.src='';
  iframeWrap.style.display='none';
  if(document.fullscreenElement) document.exitFullscreen?.();
}

searchInput.addEventListener('input', async ()=>{
  const val = searchInput.value.trim();
  main.innerHTML='';
  if(!val){
    inSearch=false;
    currentPage=1;
    loadItems();
    return;
  }
  inSearch=true;
  const results = await searchItems(val);
  results.forEach(createCard);
});

window.addEventListener('scroll', ()=>{
  if(window.innerHeight+window.scrollY>=document.body.offsetHeight-500){
    loadItems();
  }
});

// --- Fullscreen loads iframe and rotates ---
fullscreenBtn.addEventListener('click', async ()=>{
  if(!currentItem) return;
  // Determine URL
  let url = '';
  if(currentItem.media_type==='tv' || currentItem.first_air_date){
    const season = seasonSelect.value || 1;
    const episode = episodeSelect.value || 1;
    url = tvSources[0].replace('${id}', currentItem.id).replace('${season}', season).replace('${episode}', episode);
  } else {
    url = movieSources[0].replace('${id}', currentItem.id);
  }

  modalIframe.src = url;
  iframeWrap.style.display='block';

  try{
    if(!document.fullscreenElement){
      await iframeWrap.requestFullscreen?.();
    } else {
      await document.exitFullscreen?.();
    }
  }catch(err){
    console.warn(err);
  }
});

loadItems();
</script>
</body>
</html>
