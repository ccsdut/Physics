<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rat AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --accent: #6e5843;
      --accent2: #b2a28f;
      --bg1: #1c1c1c;
      --text: #e0e0e0;
      --bg-input: #2a2a2a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #111;
      color: var(--text);
    }
    .chat-wrapper {
      max-width: 800px;
      margin: 3rem auto;
      padding: 20px;
      border-radius: 16px;
      background: var(--bg1);
      border: 1px solid var(--accent2);
    }
    header h1 {
      margin: 0 0 1rem;
      color: var(--accent);
      font-size: 2rem;
      text-align: center;
    }
    #chat-container {
      min-height: 300px;
      max-height: 55vh;
      overflow-y: auto;
      padding: 15px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      font-size: 1rem;
    }
    .bubble {
      max-width: 80%;
      margin: 0.4rem 0;
      padding: 10px 14px;
      border-radius: 12px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .user {
      margin-left: auto;
      background: var(--accent2);
      color: #000;
    }
    .assistant {
      background: #333;
      border: 1px solid var(--accent);
      color: var(--accent2);
      position: relative;
    }
    .report-button {
      display: inline-block;
      margin-left: 10px;
      font-weight: 600;
      color: #3399ff;
      cursor: pointer;
      user-select: none;
      font-size: 0.9rem;
      text-decoration: underline;
    }
    .input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }
    #user-input {
      flex: 1 1 100%;
      min-height: 70px;
      padding: 12px;
      border: 1px solid var(--accent2);
      border-radius: 8px;
      background: var(--bg-input);
      color: #fff;
      font-size: 1rem;
      resize: none;
    }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent2);
      color: #000;
      transition: 0.3s;
      flex: 1 1 auto;
    }
    .btn:hover {
      background: var(--accent);
      color: #fff;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #overlay-content {
      background: var(--bg1);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      border: 1px solid var(--accent2);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #system-prompt-editor {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border-radius: 8px;
      background: var(--bg-input);
      color: white;
      border: 1px solid var(--accent2);
      font-family: monospace;
      resize: vertical;
      flex-grow: 1;
    }
    #overlay-buttons {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    #save-prompt-btn, #reset-prompt-btn {
      flex: 1 1 48%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      color: #000;
      background: var(--accent2);
    }
    #save-prompt-btn:hover {
      background: var(--accent);
      color: #fff;
    }
    #reset-prompt-btn {
      background: #b0413e;
      color: #fff;
    }
    #reset-prompt-btn:hover {
      background: #8a312e;
    }
    #user-action-buttons {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    #copy-user-btn, #load-user-btn {
      flex: 1 1 48%;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent2);
      color: #000;
      transition: 0.3s;
    }
    #copy-user-btn:hover, #load-user-btn:hover {
      background: var(--accent);
      color: #fff;
    }
    #reset-id-btn {
  width: 100%;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  background: #b0413e; /* RED color */
  color: #fff;
  transition: 0.3s;
  margin-top: 16px;
}

#reset-id-btn:hover {
  background: #8a312e;
}
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <header>
      <h1>Rat AI üêÄ</h1>
    </header>

    <div id="chat-container"></div>

    <div class="input-area">
      <textarea id="user-input" placeholder="Type your message‚Ä¶"></textarea>
      <button id="send-button" class="btn" type="button">Send</button>
      <button id="settings-button" class="btn" type="button">Settings</button>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlay-title">
    <div id="overlay-content">
      <label for="system-prompt-editor" style="font-weight:600; margin-bottom:4px; color: var(--accent2);">Edit Personality Prompt</label>
      <textarea id="system-prompt-editor" aria-label="Edit Personality Prompt"></textarea>
      <div id="overlay-buttons">
        <button id="save-prompt-btn">Save Personality</button>
        <button id="reset-prompt-btn">Reset Personality</button>
      </div>

      <hr style="border-color: var(--accent2); margin: 16px 0;" />

      <div id="user-action-buttons">
  <button id="copy-user-btn" title="Copy current User ID">Copy User</button>
  <button id="load-user-btn" title="Load chat from User ID">Load Chat from User</button>
</div>

<div id="load-user-input-container" style="display:none; margin-top: 8px;">
  <input id="load-user-input" type="text" placeholder="Enter User ID" style="width: 70%; padding: 8px; border-radius: 6px; border: 1px solid var(--accent2); background: var(--bg-input); color: var(--text); font-family: monospace;" />
  <button id="load-user-confirm-btn" style="padding: 8px 14px; margin-left: 8px; border-radius: 6px; border:none; background: var(--accent2); color: #000; cursor: pointer;">OK</button>
</div>

      <hr style="border-color: var(--accent2); margin: 16px 0;" />

      <button id="reset-id-btn" title="Reset your ID">Reset ID</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = 'https://pykqtfzcucnphogghvgq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5a3F0ZnpjdWNucGhvZ2dodmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5NTYxODEsImV4cCI6MjA2NzUzMjE4MX0.tyTCHEN863VQDwm9YyRbJT9L5meoX8n9OQqoEp_cWeU';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const chatBox = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-button');
    const settingsBtn = document.getElementById('settings-button');
    const promptEditor = document.getElementById('system-prompt-editor');
    const savePromptBtn = document.getElementById('save-prompt-btn');
    const resetPromptBtn = document.getElementById('reset-prompt-btn');
    const resetIdBtn = document.getElementById('reset-id-btn');
    const copyUserBtn = document.getElementById('copy-user-btn');
    const loadUserBtn = document.getElementById('load-user-btn');
    const overlay = document.getElementById('overlay');

    const defaultPrompt = `You're an assistant with a chill, casual vibe. Your goal is to keep things relaxed, informal, and fun! You don't always need to give detailed answers‚Äîfeel free to keep things light and easy. You can share a quick thought, ask a question, or just vibe with the user. You don't need to always answer directly but rather keep the conversation flowing smoothly. If the user asks for specific info, just keep it simple and not too heavy. Always be friendly and approachable.`;

    let systemPrompt = localStorage.getItem('customPrompt') || defaultPrompt;
    promptEditor.value = systemPrompt;

    let userId = localStorage.getItem('userId') || generateNewUserId();
    localStorage.setItem('userId', userId);

    let conversation = [];

    // Load previous messages from Supabase on start
    async function loadChatHistory(loadUserId = null) {
  const idToLoad = loadUserId || userId;
  try {
    const { data, error } = await supabase
      .from('messages')
      .select('*')
      .eq('user_id', idToLoad)
      .order('created_at', { ascending: true });
    if (error) throw error;
    chatBox.innerHTML = '';
    conversation = [];

    // Attempt to find the personality prompt from the first message (if any)
    // assuming personality_prompt is saved with every message, so pick from first
    let loadedPrompt = null;
    if (data.length > 0) {
      loadedPrompt = data[0].personality_prompt || null;
    }

    // Update prompt editor & systemPrompt if loading for a different user AND prompt exists
    if (loadUserId && loadedPrompt) {
      systemPrompt = loadedPrompt;
      promptEditor.value = systemPrompt;
      localStorage.setItem('customPrompt', systemPrompt);
    }

    for (const msg of data) {
      appendMessage(msg.role, msg.message);
      conversation.push({ role: msg.role, content: msg.message });
    }
    scrollToBottom();

    if (loadUserId) {
      userId = loadUserId;
      localStorage.setItem('userId', userId);
      appendMessage('assistant', `‚úÖ Loaded chat from user: ${userId}`);
    }
  } catch (err) {
    appendMessage('assistant', `[‚ö†Ô∏è Error loading chat history: ${err.message}]`);
  }
}

    loadChatHistory();

    settingsBtn.addEventListener('click', () => {
      overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
      promptEditor.value = systemPrompt; // refresh textarea with current prompt
    });

    resetIdBtn.addEventListener('click', () => {
      userId = generateNewUserId();
      localStorage.setItem('userId', userId);
      conversation = [];
      chatBox.innerHTML = '';
      appendMessage('assistant', `‚úÖ New ID created: ${userId}`);
      overlay.style.display = 'none';
    });

    savePromptBtn.addEventListener('click', () => {
      systemPrompt = promptEditor.value.trim();
      localStorage.setItem('customPrompt', systemPrompt);
      appendMessage('assistant', '‚úÖ Personality updated!');
      overlay.style.display = 'none';
    });

    resetPromptBtn.addEventListener('click', () => {
      promptEditor.value = defaultPrompt;
      systemPrompt = defaultPrompt;
      localStorage.setItem('customPrompt', systemPrompt);
    });

    copyUserBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(userId);
        alert(`User ID copied to clipboard:\n${userId}`);
      } catch {
        alert('Failed to copy user ID. Try manually selecting and copying.');
      }
    });

    loadUserBtn.addEventListener('click', () => {
  const container = document.getElementById('load-user-input-container');
  container.style.display = (container.style.display === 'flex') ? 'none' : 'flex';
});

// Replace the current "loadUserBtn" listener with the above, and then
// REPLACE this existing line:
//    (no current listener for 'load-user-confirm-btn')

// Instead, find this existing line (if present) for 'load-user-confirm-btn' and replace it with:
document.getElementById('load-user-confirm-btn').onclick = async () => {
  const container = document.getElementById('load-user-input-container');
  const inputEl = document.getElementById('load-user-input');
  const id = inputEl.value.trim();
  if (!id) {
    alert('Please enter a User ID.');
    return;
  }
  overlay.style.display = 'none';
  await loadChatHistory(id);
  inputEl.value = '';
  container.style.display = 'none';
};


    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.style.display = 'none';
      }
    });

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      appendMessage('user', text);
      conversation.push({ role: 'user', content: text });
      if (conversation.length > 30) {
        conversation = conversation.slice(-30);
      }

      input.value = '';
      scrollToBottom();
      sendBtn.disabled = true;

      try {
        await supabase.from('messages').insert([{
          user_id: userId,
          personality_prompt: systemPrompt,
          role: 'user',
          message: text,
        }]);
      } catch (err) {
        appendMessage('assistant', '[‚ö†Ô∏è Error saving your message.]');
        sendBtn.disabled = false;
        return;
      }

      const typingDiv = document.createElement('div');
      typingDiv.className = 'bubble assistant';
      typingDiv.textContent = 'Rat AI is typing‚Ä¶';
      chatBox.appendChild(typingDiv);
      scrollToBottom();

      try {
        const keyResponse = await fetch('https://groq-api-keys.pages.dev/apikeys.txt');
        if (!keyResponse.ok) throw new Error('Failed to fetch API key');
        const keysText = await keyResponse.text();
        const keys = keysText.trim().split('\n').filter(k => k);
        const groqApiKey = keys[Math.floor(Math.random() * keys.length)];

        const groqRequestBody = {
          model: "llama3-70b-8192",
          messages: [
            { role: "system", content: systemPrompt },
            ...conversation
          ],
          temperature: 0.7,
          max_tokens: 256,
          stream: false
        };

        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${groqApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(groqRequestBody)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const aiText = data.choices?.[0]?.message?.content || "[‚ö†Ô∏è No valid response from Rat AI.]";

        chatBox.removeChild(typingDiv);
        appendAssistantMessage(aiText);
        conversation.push({ role: 'assistant', content: aiText });
        if (conversation.length > 30) {
          conversation = conversation.slice(-30);
        }
        await supabase.from('messages').insert([{
          user_id: userId,
          personality_prompt: systemPrompt,
          role: 'assistant',
          message: aiText,
        }]);

      } catch (err) {
        chatBox.removeChild(typingDiv);
        const errorMsg = `[‚ö†Ô∏è Groq API error: ${err.message}]`;
        appendAssistantMessage(errorMsg);
      }

      sendBtn.disabled = false;
      scrollToBottom();
    }

    function generateNewUserId() {
      return 'user-' + Math.random().toString(36).substring(2, 10);
    }

    function appendMessage(sender, text) {
      const div = document.createElement('div');
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chatBox.appendChild(div);
      scrollToBottom();
    }

    function appendAssistantMessage(text) {
      const div = document.createElement('div');
      div.className = 'bubble assistant';

      if (text.includes('Groq API error')) {
        const errorSpan = document.createElement('span');
        errorSpan.textContent = text;

        const reportBtn = document.createElement('span');
        reportBtn.textContent = 'Report';
        reportBtn.className = 'report-button';
        reportBtn.title = 'Click to report this error';

        reportBtn.addEventListener('click', () => {
          sendReportToDiscord(text, reportBtn);
        });

        div.appendChild(errorSpan);
        div.appendChild(reportBtn);
      } else {
        div.textContent = text;
      }

      chatBox.appendChild(div);
      scrollToBottom();
    }

    async function sendReportToDiscord(errorText, buttonElem) {
      const webhookUrl = 'https://discord.com/api/webhooks/1391645161452339231/IH0UZIKcCovWBFoGluvoY_IiyCsjkjgBhFjAKtseqX35bp2T3eKtvCizQORt9E5J2q20';

      buttonElem.textContent = 'Reporting...';
      buttonElem.style.pointerEvents = 'none';
      buttonElem.style.color = '#777';

      try {
        const payload = {
          content: `üö® Groq API error reported:\n\`\`\`\n${errorText}\n\`\`\``
        };
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`Webhook error status: ${response.status}`);

        buttonElem.textContent = 'Reported ‚úì';
        buttonElem.style.color = '#0a0';
      } catch (err) {
        buttonElem.textContent = 'Report failed';
        buttonElem.style.color = '#a00';
        buttonElem.style.pointerEvents = 'auto';
        alert('Failed to send report: ' + err.message);
      }
    }

    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
