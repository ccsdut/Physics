<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rat AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --accent: #6e5843;
      --accent2: #b2a28f;
      --bg1: #1c1c1c;
      --text: #e0e0e0;
      --bg-input: #2a2a2a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #111;
      color: var(--text);
    }
    .chat-wrapper {
      max-width: 800px;
      margin: 3rem auto;
      padding: 20px;
      border-radius: 16px;
      background: var(--bg1);
      border: 1px solid var(--accent2);
    }
    header h1 {
      margin: 0 0 1rem;
      color: var(--accent);
      font-size: 2rem;
      text-align: center;
    }
    #chat-container {
      min-height: 300px;
      max-height: 55vh;
      overflow-y: auto;
      padding: 15px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 10px;
      font-size: 1rem;
    }
    .bubble {
      max-width: 80%;
      margin: 0.4rem 0;
      padding: 10px 14px;
      border-radius: 12px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .user {
      margin-left: auto;
      background: var(--accent2);
      color: #000;
    }
    .assistant {
      background: #333;
      border: 1px solid var(--accent);
      color: var(--accent2);
      position: relative;
    }
    .report-button {
      display: inline-block;
      margin-left: 10px;
      font-weight: 600;
      color: #3399ff;
      cursor: pointer;
      user-select: none;
      font-size: 0.9rem;
      text-decoration: underline;
    }
    .input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }
    #user-input {
      flex: 1 1 100%;
      min-height: 70px;
      padding: 12px;
      border: 1px solid var(--accent2);
      border-radius: 8px;
      background: var(--bg-input);
      color: #fff;
      font-size: 1rem;
      resize: none;
    }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent2);
      color: #000;
      transition: 0.3s;
      flex: 1 1 auto;
    }
    .btn:hover {
      background: var(--accent);
      color: #fff;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #overlay-content {
      background: var(--bg1);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      border: 1px solid var(--accent2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #system-prompt-editor {
      width: 100%;
      min-height: 120px;
      padding: 10px;
      border-radius: 8px;
      background: var(--bg-input);
      color: white;
      border: 1px solid var(--accent2);
      font-family: monospace;
      resize: vertical;
      flex-grow: 1;
    }
    #overlay-buttons {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }
    #save-prompt-btn, #reset-prompt-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }
    #save-prompt-btn {
      background: var(--accent2);
      color: #000;
    }
    #save-prompt-btn:hover {
      background: var(--accent);
      color: #fff;
    }
    #reset-prompt-btn {
      background: #b0413e;
      color: #fff;
    }
    #reset-prompt-btn:hover {
      background: #8a312e;
    }
  </style>
</head>
<body>
  <div class="chat-wrapper">
    <header>
      <h1>Rat AI üêÄ</h1>
    </header>

    <div id="chat-container"></div>

    <div class="input-area">
      <textarea id="user-input" placeholder="Type your message‚Ä¶"></textarea>
      <button id="send-button" class="btn" type="button">Send</button>
      <button id="reset-id-button" class="btn" type="button" title="Reset your ID">Reset ID</button>
      <button id="edit-prompt-btn" class="btn" type="button">Change Personality</button>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay" role="dialog" aria-modal="true" aria-labelledby="overlay-title">
    <div id="overlay-content">
      <textarea id="system-prompt-editor" aria-label="Edit Personality Prompt"></textarea>
      <div id="overlay-buttons">
        <button id="save-prompt-btn">Save Personality</button>
        <button id="reset-prompt-btn">Reset Personality</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACFdHnKCt-mpwXMz4aRO5jnAxmyOtl_d4",
      authDomain: "ai-chat-48d1a.firebaseapp.com",
      databaseURL: "https://ai-chat-48d1a-default-rtdb.firebaseio.com",
      projectId: "ai-chat-48d1a",
      storageBucket: "ai-chat-48d1a.appspot.com",
      messagingSenderId: "856538226550",
      appId: "1:856538226550:web:105a24acd395c2c8cca457",
      measurementId: "G-4GCJTM2J16"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const chatBox = document.getElementById('chat-container');
    const input = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-button');
    const resetIdBtn = document.getElementById('reset-id-button');
    const promptEditor = document.getElementById('system-prompt-editor');
    const savePromptBtn = document.getElementById('save-prompt-btn');
    const resetPromptBtn = document.getElementById('reset-prompt-btn');
    const editPromptBtn = document.getElementById('edit-prompt-btn');
    const overlay = document.getElementById('overlay');

    const defaultPrompt = `You're an assistant with a chill, casual vibe. Your goal is to keep things relaxed, informal, and fun! You don't always need to give detailed answers‚Äîfeel free to keep things light and easy. You can share a quick thought, ask a question, or just vibe with the user. You don't need to always answer directly but rather keep the conversation flowing smoothly. If the user asks for specific info, just keep it simple and not too heavy. Always be friendly and approachable.`;

    let systemPrompt = localStorage.getItem('customPrompt') || defaultPrompt;
    promptEditor.value = systemPrompt;

    let userId = localStorage.getItem('userId') || generateNewUserId();
    localStorage.setItem('userId', userId);
    let dbMessagesRef = ref(db, `messages/${userId}`);

    resetIdBtn.addEventListener('click', () => {
      userId = generateNewUserId();
      localStorage.setItem('userId', userId);
      dbMessagesRef = ref(db, `messages/${userId}`);
      conversation = [];
      chatBox.innerHTML = '';
      appendMessage('assistant', `‚úÖ New ID created: ${userId}`);
    });

    editPromptBtn.addEventListener('click', () => {
      overlay.style.display = overlay.style.display === 'flex' ? 'none' : 'flex';
      if (!location.search.includes('change-personality')) {
        history.pushState(null, '', '?change-personality');
      }
    });

    savePromptBtn.addEventListener('click', () => {
      systemPrompt = promptEditor.value.trim();
      localStorage.setItem('customPrompt', systemPrompt);
      appendMessage('assistant', '‚úÖ Personality updated!');
      overlay.style.display = 'none';
      if (location.search.includes('change-personality')) {
        history.replaceState(null, '', location.pathname);
      }
    });

    resetPromptBtn.addEventListener('click', () => {
      promptEditor.value = defaultPrompt;
      systemPrompt = defaultPrompt;
      localStorage.setItem('customPrompt', systemPrompt);
    });

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.style.display = 'none';
        if (location.search.includes('change-personality')) {
          history.replaceState(null, '', location.pathname);
        }
      }
    });

    if (location.search.includes('change-personality')) {
      overlay.style.display = 'flex';
    }

    let conversation = [];

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      appendMessage('user', text);
      conversation.push({ role: 'user', content: text });
      if (conversation.length > 30) {
        conversation = conversation.slice(-30);
      }

      input.value = '';
      scrollToBottom();
      sendBtn.disabled = true;

      try {
        await push(dbMessagesRef, { role: 'user', content: text });
      } catch (err) {
        appendMessage('assistant', '[‚ö†Ô∏è Error saving your message.]');
        sendBtn.disabled = false;
        return;
      }

      const typingDiv = document.createElement('div');
      typingDiv.className = 'bubble assistant';
      typingDiv.textContent = 'Rat AI is typing‚Ä¶';
      chatBox.appendChild(typingDiv);
      scrollToBottom();

      try {
        const groqApiKey = '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'; // ‚úÖ updated key here
        const groqRequestBody = {
          model: "llama3-70b-8192",
          messages: [
            { role: "system", content: systemPrompt },
            ...conversation
          ],
          temperature: 0.7,
          max_tokens: 256,
          stream: false
        };

        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${groqApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(groqRequestBody)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        const aiText = data.choices?.[0]?.message?.content || "[‚ö†Ô∏è No valid response from Rat AI.]";

        chatBox.removeChild(typingDiv);
        appendAssistantMessage(aiText);
        conversation.push({ role: 'assistant', content: aiText });
        if (conversation.length > 30) {
          conversation = conversation.slice(-30);
        }
        await push(dbMessagesRef, { role: 'assistant', content: aiText });

      } catch (err) {
        chatBox.removeChild(typingDiv);
        const errorMsg = `[‚ö†Ô∏è Groq API error: ${err.message}]`;
        appendAssistantMessage(errorMsg);
      }

      sendBtn.disabled = false;
      scrollToBottom();
    }

    function generateNewUserId() {
      return 'user-' + Math.random().toString(36).substring(2, 10);
    }

    function appendMessage(sender, text) {
      const div = document.createElement('div');
      div.className = `bubble ${sender}`;
      div.textContent = text;
      chatBox.appendChild(div);
      scrollToBottom();
    }

    function appendAssistantMessage(text) {
      const div = document.createElement('div');
      div.className = 'bubble assistant';

      // Check if this message contains a Groq API error
      if (text.includes('Groq API error')) {
        // Create text span for the error message (excluding the "[‚ö†Ô∏è Groq API error: " prefix)
        const errorText = text;

        // Create span for the error message text
        const errorSpan = document.createElement('span');
        errorSpan.textContent = errorText;

        // Create report button
        const reportBtn = document.createElement('span');
        reportBtn.textContent = 'Report';
        reportBtn.className = 'report-button';
        reportBtn.title = 'Click to report this error';

        reportBtn.addEventListener('click', () => {
          sendReportToDiscord(errorText, reportBtn);
        });

        div.appendChild(errorSpan);
        div.appendChild(reportBtn);
      } else {
        div.textContent = text;
      }

      chatBox.appendChild(div);
      scrollToBottom();
    }

    async function sendReportToDiscord(errorText, buttonElem) {
      const webhookUrl = 'https://discord.com/api/webhooks/1391645161452339231/IH0UZIKcCovWBFoGluvoY_IiyCsjkjgBhFjAKtseqX35bp2T3eKtvCizQORt9E5J2q20';

      buttonElem.textContent = 'Reporting...';
      buttonElem.style.pointerEvents = 'none';
      buttonElem.style.color = '#777';

      try {
        const payload = {
          content: `üö® Groq API error reported:\n\`\`\`\n${errorText}\n\`\`\``
        };
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error(`Webhook error status: ${response.status}`);

        buttonElem.textContent = 'Reported ‚úì';
        buttonElem.style.color = '#0a0';
      } catch (err) {
        buttonElem.textContent = 'Report failed';
        buttonElem.style.color = '#a00';
        buttonElem.style.pointerEvents = 'auto';
        alert('Failed to send report: ' + err.message);
      }
    }

    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
