<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spotify Playlist Viewer with YouTube Player</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: auto;
    background: #121212;
    color: #eee;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    font-size: 1rem;
    box-sizing: border-box;
    border-radius: 5px;
    border: none;
  }
  input {
    background: #222;
    color: #eee;
  }
  button {
    background: #1db954;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #17a44d;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  li {
    padding: 10px 5px;
    border-bottom: 1px solid #333;
    cursor: pointer;
  }
  .track-name {
    font-weight: bold;
    color: #1db954;
    text-decoration: underline;
  }
  .artist-name {
    color: #aaa;
  }
  .youtube-player-wrapper iframe {
    width: 100%;
    height: 0px; /* iframe hidden */
    border: 0;
  }
  .player-controls {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 4px;
  }
  .progress-container {
    width: 100%;
    background: #444;
    height: 12px; /* thicker seek bar */
    cursor: pointer;
    position: relative;
  }
  .progress-bar {
    background: #1db954;
    height: 100%;
    width: 0%;
  }
  .time-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: #ccc;
    margin-bottom: 4px;
  }
  .button-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
</style>
</head>
<body>

<h2>Spotify Playlist Viewer with YouTube Player</h2>

<label for="playlistUrl">Spotify Playlist URL:</label>
<input type="text" id="playlistUrl" placeholder="Paste a public Spotify playlist URL here" />

<button id="loadBtn">Load Playlist</button>

<div id="playlistInfo"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  let allTracks = [];
  let currentTrackIndex = -1;
  let currentPlayerId = null;
  let currentAnimation = null;
  const players = {};

  async function getToken() {
    const res = await fetch('https://spotify-nu-six.vercel.app/api/token');
    const data = await res.json();
    return data.access_token;
  }

  const playlistUrlInput = document.getElementById('playlistUrl');
  const loadBtn = document.getElementById('loadBtn');
  const playlistInfo = document.getElementById('playlistInfo');

  function extractPlaylistId(url) {
    let match = url.match(/playlist\/([a-zA-Z0-9]+)(\?|$)/);
    if (match) return match[1];
    match = url.match(/spotify:playlist:([a-zA-Z0-9]+)/);
    if (match) return match[1];
    return null;
  }

  async function searchYouTubeVideo(query) {
    const proxyUrl = 'https://corsproxy.io/?';
    const searchUrl = 'https://www.youtube.com/results?search_query=' + encodeURIComponent(query);
    try {
      const res = await fetch(proxyUrl + searchUrl);
      const text = await res.text();
      const jsonMatch = text.match(/var ytInitialData = (.*?);<\/script>/s);
      if (!jsonMatch) return null;
      const ytInitialData = JSON.parse(jsonMatch[1]);
      const contents = ytInitialData.contents?.twoColumnSearchResultsRenderer?.primaryContents?.sectionListRenderer?.contents;
      if (!contents) return null;
      for (const section of contents) {
        const itemSection = section.itemSectionRenderer;
        if (!itemSection) continue;
        const items = itemSection.contents;
        for (const item of items) {
          if (item.videoRenderer) {
            return item.videoRenderer.videoId;
          }
        }
      }
      return null;
    } catch (e) {
      console.error('YouTube search error:', e);
      return null;
    }
  }

  window.onYouTubeIframeAPIReady = () => {};

  loadBtn.addEventListener('click', async () => {
    const playlistUrl = playlistUrlInput.value.trim();
    if (!playlistUrl) return alert('Please enter a Spotify playlist URL.');
    const playlistId = extractPlaylistId(playlistUrl);
    if (!playlistId) return alert('Invalid Spotify playlist URL.');

    playlistInfo.innerHTML = 'Loading playlist...';
    const token = await getToken();

    try {
      let tracks = [], nextUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=50`;
      while (nextUrl) {
        const res = await fetch(nextUrl, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) return playlistInfo.innerHTML = 'Failed to load playlist tracks.';
        const data = await res.json();
        tracks = tracks.concat(data.items);
        nextUrl = data.next;
      }

      allTracks = tracks.map((item, index) => {
        const track = item.track;
        if (!track) return null;
        const artists = track.artists.map(a => a.name).join(', ');
        // Unique id for duplicates
        const uniqueId = `${track.name.replace(/\W/g, '')}_${artists.replace(/\W/g, '')}_${index}`;
        return {
          id: uniqueId,
          index,
          name: track.name,
          artists,
          query: `${track.name} ${artists}`,
          title: `${track.name} - ${artists}`
        };
      }).filter(Boolean);

      let html = `<h3>Playlist Tracks (${allTracks.length}):</h3><ul>`;
      for (const track of allTracks) {
        html += `
          <li data-id="${track.id}">
            <div class="track-info">
              <span class="track-name">${track.name}</span><br/>
              <span class="artist-name">${track.artists}</span>
            </div>
            <div class="player-slot"></div>
          </li>`;
      }
      html += '</ul>';
      playlistInfo.innerHTML = html;

      document.querySelectorAll('li').forEach(item => {
        item.addEventListener('click', (e) => {
          // Prevent click if interacting with controls
          if (e.target.tagName === 'BUTTON' || e.target.classList.contains('progress-container')) return;
          const id = item.getAttribute('data-id');
          const track = allTracks.find(t => t.id === id);
          if (track) {
            playTrackById(track.id);
          }
        });
      });
    } catch (e) {
      playlistInfo.innerHTML = 'Error loading playlist.';
      console.error(e);
    }
  });

  async function playTrackById(id) {
    const track = allTracks.find(t => t.id === id);
    if (!track) return;
    currentTrackIndex = allTracks.indexOf(track);
    const item = document.querySelector(`li[data-id="${id}"]`);
    const slot = item.querySelector('.player-slot');
    if (!slot) return;
    slot.innerHTML = 'Loading player...';

    const videoId = await searchYouTubeVideo(track.query);
    if (!videoId) return;

    if (currentPlayerId && players[currentPlayerId]) {
      players[currentPlayerId].destroy();
      cancelAnimationFrame(currentAnimation);
    }

    const playerId = `player-${videoId}-${Date.now()}`;
    currentPlayerId = playerId;
    const embedUrl = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&controls=0`;
    slot.innerHTML = `
      <div class="youtube-player-wrapper">
        <iframe id="${playerId}" src="${embedUrl}" allow="autoplay"></iframe>
        <div class="player-controls">
          <div class="time-info">
            <span id="time-left-${playerId}">0:00</span>
            <span id="time-right-${playerId}">0:00</span>
          </div>
          <div class="progress-container" onclick="seek(event, '${playerId}')">
            <div class="progress-bar" id="bar-${playerId}"></div>
          </div>
          <div class="button-row">
            <button onclick="seekRelative('${playerId}', -10)">⏮</button>
            <button onclick="togglePlayPause('${playerId}', this)">⏸</button>
            <button onclick="seekRelative('${playerId}', 10)">⏭</button>
            <button onclick="downloadMP3('${videoId}', \`${track.title}\`)">⤓</button>
          </div>
        </div>
      </div>`;

    players[playerId] = new YT.Player(playerId, {
      events: {
        onReady: () => updateTimeLoop(playerId),
        onStateChange: (e) => {
          if (e.data === YT.PlayerState.ENDED) playTrackByIndex(currentTrackIndex + 1);
        }
      }
    });
  }

  async function playTrackByIndex(index) {
    if (index < 0 || index >= allTracks.length) return;
    const track = allTracks[index];
    if (!track) return;
    playTrackById(track.id);
  }

  function togglePlayPause(playerId, btn) {
    const player = players[playerId];
    if (!player) return;
    const state = player.getPlayerState();
    if (state === 1) {
      player.pauseVideo();
      btn.textContent = '▶️';
    } else {
      player.playVideo();
      btn.textContent = '⏸';
    }
  }
  function seekRelative(playerId, seconds) {
    const player = players[playerId];
    if (!player) return;
    const current = player.getCurrentTime();
    player.seekTo(current + seconds, true);
  }
  function seek(event, playerId) {
    const player = players[playerId];
    if (!player) return;
    const bar = event.currentTarget;
    const rect = bar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percent = clickX / rect.width;
    const duration = player.getDuration();
    player.seekTo(duration * percent, true);
  }
  function updateTimeLoop(playerId) {
    const player = players[playerId];
    if (!player) return;
    const bar = document.getElementById(`bar-${playerId}`);
    const left = document.getElementById(`time-left-${playerId}`);
    const right = document.getElementById(`time-right-${playerId}`);
    function update() {
      if (!player || player.getDuration() === 0) return;
      const cur = player.getCurrentTime();
      const dur = player.getDuration();
      left.textContent = formatTime(cur);
      right.textContent = formatTime(dur);
      bar.style.width = `${(cur / dur) * 100}%`;
      currentAnimation = requestAnimationFrame(update);
    }
    update();
  }
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }
  function downloadMP3(videoId, title) {
    const url = `https://yt1d.com/en307/watch?v=${videoId}`;
    window.open(url, '_blank');
  }
</script>
</body>
</html>
